define("mod_minilesson/speakinggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss","mod_minilesson/progresstimer"],(function($,log,ajax,def,polly,cloudpoodll,ttrecorder,anim,progresstimer){return log.debug("MiniLesson speaking gap fill: initialising"),{clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var self=this,theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("Speech at speaking gap fill");var words=self.items[self.game.pointer].words,maskedwords=[];Object.keys(words).forEach((function(key){maskedwords.push(words[key])})),console.log(maskedwords.join(" ")),console.log(message.capturedspeech),self.getComparison(maskedwords.join(" "),message.capturedspeech,self.items[self.game.pointer].phonetic,(function(comparison){self.gotComparison(comparison,message)}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),opts.wwwroot=quizhelper.is_stt_guided(),ttrecorder.clone().init(opts)}else cloudpoodll.init("minilesson-recorder-listenrepeat-"+itemdata.id,theCallback);self.itemdata=itemdata,self.quizhelper=quizhelper,self.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),self.register_events(),self.setvoice(),self.getItems()},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.quizhelper.do_next(stepdata)},register_events:function(){var self=this;$("#"+self.itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){self.next_question()})),$("#"+self.itemdata.uniqueid+"_container .landr_start_btn").on("click",(function(){self.start()})),$("#"+self.itemdata.uniqueid+"_container .landr_listen_btn").on("click",(function(){self.items[self.game.pointer].audio.load(),self.items[self.game.pointer].audio.play()})),$("#"+self.itemdata.uniqueid+"_container .landr_skip_btn").on("click",(function(){$("#"+self.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .landr_speech.landr_teacher_left").text(self.items[self.game.pointer].prompt+""),$("#"+self.itemdata.uniqueid+"_container .landr_targetWord").each((function(){var realidx=$(this).data("realidx"),landr_targetWord=self.items[self.game.pointer].landr_targetWords[realidx];$(this).val(landr_targetWord)})),self.game.pointer<self.items.length-1?setTimeout((function(){$(".landr_reply_"+self.game.pointer).hide(),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer++,self.nextPrompt()}),2e3):self.end()}))},game:{pointer:0},usevoice:"",setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,displayprompt:target.displayprompt,definition:target.definition,phonetic:target.phonetic,words:target.words,typed:"",answered:!1,correct:!1,audio:null}})).filter((function(e){return""!==e.target})),$.each(self.items,(function(index,item){polly.fetch_polly_url(item.prompt,self.voiceoption,self.usevoice).then((function(audiourl){item.audio=new Audio,item.audio.src=audiourl,0===self.items.filter((function(e){return null===e.audio})).length&&self.appReady()}))}))},appReady:function(){$("#"+this.itemdata.uniqueid+"_container .landr_not_loaded").hide(),$("#"+this.itemdata.uniqueid+"_container .landr_loaded").show(),$("#"+this.itemdata.uniqueid+"_container .landr_start_btn").prop("disabled",!1)},gotComparison:function(comparison,typed){var self=this,feedback=$("#"+self.itemdata.uniqueid+"_container .landr_reply_"+self.game.pointer+" .dictate_feedback[data-idx='"+self.game.pointer+"']");if($("#"+self.itemdata.uniqueid+"_container .landr_targetWord").removeClass("landr_correct landr_incorrect"),$("#"+self.itemdata.uniqueid+"_container .landr_feedback").removeClass("fa fa-check fa-times"),0==comparison.filter((function(e){return!e.matched})).length&&comparison&&comparison.length>0)self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .landr_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');"input"===data.type&&characterinput.val(data.character)})),feedback.removeClass("fa fa-times"),feedback.addClass("fa fa-check"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=typed,$("#"+self.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),self.game.pointer<self.items.length-1?setTimeout((function(){$(".landr_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end();else{feedback.removeClass("fa fa-check"),feedback.addClass("fa fa-times"),comparison.forEach((function(obj){var words=self.items[self.game.pointer].words;Object.keys(words).forEach((function(key){words[key]==obj.word&&(obj.matched?self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .landr_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val(data.character)})):self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .landr_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val("")})))}))}));var thereply=$("#"+self.itemdata.uniqueid+"_container .landr_reply_"+self.game.pointer);anim.do_animate(thereply,"shakeX animate__faster").then((function(){$("#"+self.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1)}))}$("#"+self.itemdata.uniqueid+"_container .landr_targetWord.landr_correct").each((function(){var realidx=$(this).data("realidx"),landr_targetWord=self.items[self.game.pointer].landr_targetWords[realidx];$(this).val(landr_targetWord)}))},getComparison:function(passage,transcript,phonetic,callback){$(".landr_ctrl-btn").prop("disabled",!0),this.quizhelper.comparePassageToTranscript(passage,transcript,phonetic,this.itemdata.language).then((function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)}))},end:function(){var self=this;$(".minilesson_nextbutton").prop("disabled",!0),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),self.next_question()}),2200)},start:function(){$("#"+this.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),$("#"+this.itemdata.uniqueid+"_container .landr_speakbtncontainer").show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,$("#"+this.itemdata.uniqueid+"_container .question").show(),$("#"+this.itemdata.uniqueid+"_container .landr_start_btn").hide(),$("#"+this.itemdata.uniqueid+"_container .landr_mainmenu").hide(),$("#"+this.itemdata.uniqueid+"_container .landr_controls").show(),this.nextPrompt()},nextPrompt:function(){var color,self=this;$(".landr_ctrl-btn").prop("disabled",!1);var progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");$("#"+self.itemdata.uniqueid+"_container .landr_title").html(progress);var newprompt=$(".landr_prompt_"+self.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),self.nextReply()},nextReply:function(){var self=this,code="<div class='landr_reply landr_reply_"+self.game.pointer+" text-center' style='display:none;'>";code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){"input"===data.type?code+="<input class='single-character' type='text' name='filltext"+index+"' maxlength='1' data-index='"+index+"' readonly>":"mtext"===data.type?code+="<input class='single-character-mtext' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),code+=" <i data-idx='"+self.game.pointer+"' class='dictate_feedback'></i></div>",code+="<div class='definition-container'>",code+="<div class='definition'>"+self.items[self.game.pointer].definition+"</div>",code+="</div>",$("#"+self.itemdata.uniqueid+"_container .question").append(code);var newreply=$(".landr_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),$("#"+self.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1);var inputElements=[...document.querySelectorAll(".landr_reply_"+self.game.pointer+" input.single-character")];self.formReady(inputElements),self.itemdata.timelimit>0&&($("#"+self.itemdata.uniqueid+"_container .progress-container").show(),$("#"+self.itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,warningThreshold:10,baseStyle:"bg-danger progress-bar progress-bar-animated",warningStyle:"bg-danger progress-bar progress-bar-animated",completeStyle:"bg-danger progress-bar progress-bar-animated",onFinish:function(){$("#"+self.itemdata.uniqueid+"_container .dictate_check_btn").trigger("click")}})),self.quizhelper.mobile_user()||setTimeout((function(){$("#"+self.itemdata.uniqueid+"_container .landr_listen_btn").trigger("click")}),1e3)},formReady:function(inputElements){inputElements.forEach((function(ele,index){ele.addEventListener("keydown",(function(e){8===e.keyCode&&""===e.target.value&&inputElements[Math.max(0,index-1)].focus()})),ele.addEventListener("input",(function(e){const[first,...rest]=e.target.value;e.target.value=null!=first?first:"";const lastInputBox=index===inputElements.length-1;void 0!==first&&!lastInputBox&&(inputElements[index+1].focus(),inputElements[index+1].value=rest.join(""),inputElements[index+1].dispatchEvent(new Event("input")))}))}))}}}));

//# sourceMappingURL=speakinggapfill.min.js.map